---
title: "Expected Value of Eliminating Causal Ambiguity (EVECA) for Development and Agriculture Decisions"
author: "Cory Whitney"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EVECA for Development and Agriculture Decisions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
)
```

# Introduction

## Causal Ambiguity in Development and Agriculture

Development and agricultural interventions operate under profound **causal ambiguity**—multiple competing theories of change exist for how interventions affect nutrition, livelihoods, and environmental outcomes. For example, a nutrition-sensitive agriculture program might improve child nutrition through different pathways: increased household income enabling food purchases, improved women's empowerment affecting intra-household allocation, enhanced dietary diversity from home production, or reduced disease burden through water-sanitation linkages.

The **Expected Value of Eliminating Causal Ambiguity (EVECA)** is a decision-theoretic framework that quantifies the value of resolving this structural uncertainty. EVECA extends traditional value of information analysis to handle causal ambiguity, providing development organizations, policymakers, and researchers with principled tools to value causal clarity in complex decision contexts.

This vignette demonstrates how to use the `evca` R package to compute and visualize EVECA for development and agriculture decisions, with applications relevant to CGIAR research priorities and Sustainable Development Goals (SDGs).

## Installation

```{r install, eval=FALSE}
# Install from GitHub (when available)
# devtools::install_github("corywhitney/evca")

# Or install from CRAN (when available)
# install.packages("evca")

# Or install locally from source
# devtools::install_local("path/to/evca")
```

## Loading the Package

```{r load}
library(evca)
library(ggplot2)
```

# Basic Usage for Development Decisions

## The `compute_evca()` Function

The core function of the package is `compute_evca()`, which takes three main arguments:

1. `model_utilities`: A matrix where rows are decisions (interventions) and columns are causal models
2. `model_probs`: A vector of probabilities for each causal model (must sum to 1)
3. `utility_function`: An optional function to transform outcomes to utilities (default: identity)

### Example 1: Nutrition-Sensitive Agriculture Decision

Consider a CGIAR research program deciding among three nutrition-sensitive agriculture interventions with four competing causal pathways:

```{r example1}
# Create model utilities matrix for nutrition-sensitive agriculture
model_utilities <- matrix(
  c(
    0.85, 0.72, 0.91, 0.78,   # Homestead food production under 4 causal pathways
    0.68, 0.81, 0.59, 0.73,   # Biofortified crops under 4 causal pathways
    0.92, 0.85, 0.71, 0.87    # Women's empowerment + agriculture under 4 causal pathways
  ),
  nrow = 3,
  ncol = 4,
  dimnames = list(
    c("Homestead Production", "Biofortified Crops", "Women's Empowerment"),
    c("Income Pathway", "Production Pathway", "Empowerment Pathway", "Integrated Pathway")
  )
)

# Model probabilities from evidence synthesis in East Africa
model_probs <- c(0.30, 0.25, 0.20, 0.25)

# Compute EVECA
result <- compute_evca(model_utilities, model_probs)

# View key results
cat("EVECA (value of eliminating causal ambiguity):", round(result$evca, 3), "\n")
cat("Optimal intervention under ambiguity:", result$optimal_decision_bma, "\n")
cat("Expected utility of optimal intervention:", round(result$optimal_utility_bma, 3), "\n")
cat("Expected utility with perfect causal information:", round(result$perfect_info_expected_utility, 3), "\n")
```

### Example 2: Multi-Dimensional Outcomes with SDG Weights

Development interventions typically affect multiple Sustainable Development Goals (SDGs). Here's how to incorporate multi-dimensional outcomes:

```{r example2}
# Define multi-attribute utility function for SDG outcomes
# Outcomes: [SDG2: Dietary Diversity, SDG3: Child Health, SDG5: Women's Empowerment, SDG13: Climate]
sdg_weights <- c(0.35, 0.35, 0.20, 0.10)  # Weights from stakeholder consultation

multi_attribute_utility <- function(outcomes, weights = sdg_weights) {
  # Simple linear multi-attribute utility
  sum(weights * outcomes)
}

# Create outcome array: [interventions × models × outcomes]
model_outcomes <- array(
  dim = c(3, 4, 4),
  dimnames = list(
    c("Homestead Production", "Biofortified Crops", "Women's Empowerment"),
    c("Income Pathway", "Production Pathway", "Empowerment Pathway", "Integrated Pathway"),
    c("Dietary Diversity", "Child HAZ", "Women's Empowerment", "Carbon Seq")
  )
)

# Fill with example values (in practice, from data or models)
model_outcomes[1, , ] <- matrix(c(0.8, 0.15, 0.3, 0.1, 1.2, 0.25, 0.2, 0.2,
                                  0.5, 0.10, 0.6, 0.1, 1.0, 0.20, 0.4, 0.15), nrow=4, byrow=TRUE)
model_outcomes[2, , ] <- matrix(c(0.6, 0.30, 0.1, 0.05, 0.9, 0.40, 0.1, 0.1,
                                  0.4, 0.20, 0.3, 0.05, 0.7, 0.35, 0.2, 0.08), nrow=4, byrow=TRUE)
model_outcomes[3, , ] <- matrix(c(0.4, 0.10, 0.8, 0.02, 0.6, 0.15, 0.7, 0.05,
                                  0.8, 0.25, 1.2, 0.03, 0.7, 0.20, 1.0, 0.04), nrow=4, byrow=TRUE)

# Compute multi-attribute utilities
model_utilities_sdg <- matrix(NA, nrow = 3, ncol = 4)
for (i in 1:3) {
  for (j in 1:4) {
    model_utilities_sdg[i, j] <- multi_attribute_utility(model_outcomes[i, j, ])
  }
}
rownames(model_utilities_sdg) <- rownames(model_utilities)
colnames(model_utilities_sdg) <- colnames(model_utilities)

# Compute EVECA with multi-dimensional outcomes
result_sdg <- compute_evca(model_utilities_sdg, model_probs)

cat("EVECA with SDG-weighted outcomes:", round(result_sdg$evca, 3), "\n")
cat("Optimal intervention considering SDG trade-offs:", result_sdg$optimal_decision_bma, "\n")
```

# Visualization for Development Contexts

The `plot_development()` function creates development-specific visualizations of EVECA results:

```{r plot}
# Create basic EVECA plot
p1 <- plot_development(result,
                       plot_type = "evca_bars",
                       title = "EVECA Analysis: Nutrition-Sensitive Agriculture")

# Create SDG contributions plot
p2 <- plot_development(result_sdg,
                       model_outcomes = model_outcomes,
                       sdg_weights = sdg_weights,
                       plot_type = "sdg_contributions",
                       title = "SDG Contributions by Intervention and Causal Pathway")

print(p1)
print(p2)
```

# Example Analysis for Development Contexts

The `example_development()` function provides complete demonstrations for different development contexts:

```{r example-function}
# Run example analysis for agriculture context
ag_result <- example_development(
  context = "agriculture",
  sdg_weights = c(0.35, 0.35, 0.20, 0.10),
  seed = 456
)

# View results
cat("Agriculture Example:\n")
cat("EVECA:", round(ag_result$evca_result$evca, 3), "\n")
cat("Optimal intervention:", ag_result$decision_names[ag_result$evca_result$optimal_decision_bma], "\n")
cat("Context:", ag_result$context, "\n")

# Plot agriculture example results
p_ag <- plot_development(ag_result$evca_result,
                         model_outcomes = ag_result$model_outcomes,
                         sdg_weights = ag_result$sdg_weights,
                         plot_type = "sdg_contributions",
                         title = "Agriculture Example: SDG Contributions")

print(p_ag)
```

# Real-World Application: CGIAR Research Prioritization

## Nutrition-Sensitive Agriculture Portfolio Allocation

Consider a CGIAR research program in East Africa deciding how to allocate resources among competing nutrition-sensitive agriculture interventions:

```{r cgiar-example}
# CGIAR research prioritization example
cgiar_utilities <- matrix(
  c(
    0.82, 0.71, 0.88, 0.76,   # Homestead food production
    0.65, 0.78, 0.58, 0.70,   # Biofortified staple crops
    0.89, 0.82, 0.68, 0.84,   # Women's empowerment + agriculture
    0.75, 0.85, 0.72, 0.79    # Climate-smart agriculture
  ),
  nrow = 4,
  ncol = 4,
  dimnames = list(
    c("Homestead Production", "Biofortified Crops",
      "Women's Empowerment", "Climate-Smart Ag"),
    c("Income Pathway", "Production Pathway",
      "Empowerment Pathway", "Integrated Pathway")
  )
)

# Model probabilities from mixed-methods evidence synthesis
cgiar_probs <- c(0.30, 0.25, 0.20, 0.25)

# Compute EVECA for CGIAR portfolio
cgiar_result <- compute_evca(cgiar_utilities, cgiar_probs)

# Create visualization for CGIAR decision-makers
p_cgiar <- plot_development(cgiar_result,
                           plot_type = "evca_bars",
                           title = "CGIAR Research Portfolio: Value of Eliminating Causal Ambiguity")

print(p_cgiar)

# Interpret results for CGIAR decision-making
cat("CGIAR Research Prioritization Example:\n")
cat("EVECA:", round(cgiar_result$evca, 3), "\n")
cat("Optimal intervention:", rownames(cgiar_utilities)[cgiar_result$optimal_decision_bma], "\n")
cat("Value of eliminating causal ambiguity:", round(cgiar_result$evca, 3), "utility units\n")
cat("\nInterpretation:\n")
cat("The EVECA of", round(cgiar_result$evca, 3), "represents the gain in multi-attribute utility\n")
cat("from knowing which causal pathway drives nutrition outcomes.\n")
```

# Advanced Usage for Development Practitioners

## Custom Utility Functions for Development Contexts

Development decisions often involve complex value trade-offs:

```{r custom-utility}
# Define development-specific utility functions

# Diminishing returns utility (common in development)
diminishing_utility <- function(x, alpha = 0.5) {
  if (alpha == 1) {
    return(log(x))
  }
  (x^(1 - alpha) - 1) / (1 - alpha)
}

# Threshold utility (meeting minimum standards)
threshold_utility <- function(x, threshold = 0.5) {
  ifelse(x >= threshold, 1, x/threshold)
}

# Use custom utility function with EVECA
result_custom <- compute_evca(
  model_utilities,
  model_probs,
  utility_function = function(x) diminishing_utility(x, alpha = 0.3)
)

cat("EVECA with diminishing returns utility:", round(result_custom$evca, 3), "\n")
```

## Working with Real Development Data

The package integrates with common development data formats:

```{r real-data, eval=FALSE}
# Example: Integrating with impact evaluation data
# library(dplyr)
# library(tidyr)
#
# # Load impact evaluation results
# impact_data <- read.csv("impact_evaluation_results.csv")
#
# # Extract utilities for different causal models
# model_utilities <- impact_data %>%
#   group_by(intervention, causal_model) %>%
#   summarise(utility = mean(outcome * weight), .groups = "drop") %>%
#   pivot_wider(names_from = causal_model, values_from = utility) %>%
#   column_to_rownames("intervention") %>%
#   as.matrix()
#
# # Compute EVECA
# result <- compute_evca(model_utilities, model_probs)
```

# Best Practices for Development Applications

## 1. Eliciting Causal Models and Probabilities

### Expert Elicitation Process:
- **Structured workshops** with domain experts to identify competing causal mechanisms
- **Literature synthesis** to identify theories of change from existing research
- **Mixed-methods evidence** combining quantitative and qualitative studies
- **Bayesian updating** as new evidence becomes available

## 2. Specifying Multi-Attribute Utility Functions

### Stakeholder Engagement for SDG Weights:
- **Participatory workshops** with beneficiaries, implementers, and policymakers
- **Pairwise comparisons** or **swing weighting** exercises
- **Transparent documentation** of value trade-offs
- **Sensitivity analysis** to different weighting schemes

## 3. Context Adaptation and Scaling Considerations

### Accounting for Context Heterogeneity:
- **Spatial variation**: Different causal mechanisms in different regions
- **Temporal dynamics**: Mechanisms may change over time
- **Institutional factors**: Implementation capacity affects which mechanisms operate
- **Beneficiary characteristics**: Different pathways for different sub-groups

## 4. Integration with Development Monitoring and Evaluation

### M&E System Integration:
- **Track model probabilities** over time as evidence accumulates
- **Monitor causal mechanisms** through process evaluation
- **Adaptive management**: Adjust interventions based on learning
- **Learning agendas**: Prioritize research to resolve key uncertainties

# Conclusion

The `evca` package provides a decision-theoretic framework for valuing causal clarity in development and agriculture interventions. By quantifying the Expected Value of Eliminating Causal Ambiguity, EVECA helps development organizations make better decisions under structural uncertainty while investing wisely in the learning needed for future decisions.

## Key Applications for Development Practitioners:

1. **Research prioritization**: Allocate resources between parameter refinement and causal clarification research
2. **Program design**: Choose interventions robust to causal ambiguity while investing in learning
3. **Adaptive management**: Adjust programs as evidence accumulates about causal mechanisms
4. **Stakeholder engagement**: Make explicit the value trade-offs and uncertainties in development decisions
5. **Portfolio allocation**: Optimize resource allocation across interventions and contexts

## Getting Started with EVECA in Your Organization:

1. **Start small**: Apply to one program or research portfolio
2. **Build capacity**: Train staff in decision analysis and Bayesian methods
3. **Integrate systems**: Link with existing M&E and planning processes
4. **Iterate and learn**: Refine models and probabilities as evidence accumulates
5. **Share learning**: Contribute to collective understanding of causal mechanisms in development

For development organizations operating under causal ambiguity—which is to say, all development organizations—EVECA offers a principled approach to answering critical questions: How much should we invest in understanding why our interventions work? Which causal uncertainties matter most for decision-making? How should we adapt our programs as we learn about causal mechanisms?

# References

## Value of Information and Decision Analysis
- Claxton, K. (1999). The irrelevance of inference: a decision-making approach to the stochastic evaluation of health care technologies. *Journal of Health Economics*, 18(3), 341-364.
- Yokota, F., & Thompson, K. M. (2004). Value of information analysis in environmental health risk management decisions: past, present, and future. *Risk Analysis*, 24(3), 635-650.

## Causal Inference and Structural Uncertainty
- Pearl, J. (2009). *Causality: Models, Reasoning, and Inference* (2nd ed.). Cambridge University Press.
- Hernán, M. A., & Robins, J. M. (2020). *Causal Inference: What If*. Chapman & Hall/CRC.

## Bayesian Model Averaging
- Hoeting, J. A., Madigan, D., Raftery, A. E., & Volinsky, C. T. (1999). Bayesian model averaging: a tutorial. *Statistical Science*, 14(4), 382-401.

## Development Economics and Impact Evaluation
- Banerjee, A. V., & Duflo, E. (2009). The experimental approach to development economics. *Annual Review of Economics*, 1(1), 151-178.
- Barrett, C. B., & Carter, M. R. (2010). The power and pitfalls of experiments in development economics: Some non-random reflections. *Applied Economic Perspectives and Policy*, 32(4), 515-548.

## Nutrition-Sensitive Agriculture
- Ruel, M. T., & Alderman, H. (2013). Nutrition-sensitive interventions and programmes: how can they help to accelerate progress in improving maternal and child nutrition? *The Lancet*, 382(9891), 536-551.
- Ruel, M. T., Quisumbing, A. R., & Balagamwala, M. (2018). Nutrition-sensitive agriculture: What have we learned so far? *Global Food Security*, 17, 128-153.

## CGIAR and Agricultural Development
- CGIAR. (2020). *CGIAR 2030 Research and Innovation Strategy: Transforming Food, Land, and Water Systems in a Climate Crisis*. CGIAR System Organization.
